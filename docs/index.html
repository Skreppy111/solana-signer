<script>
    let wallet;

    // ✅ Manually import bs58 if not already loaded
    async function loadBs58() {
        if (typeof bs58 === "undefined") {
            console.log("⏳ Loading bs58 manually...");
            await import("https://cdn.jsdelivr.net/npm/bs58").then((module) => {
                window.bs58 = module;
                console.log("✅ bs58 is now loaded!");
            }).catch(err => {
                console.error("❌ Failed to load bs58!", err);
            });
        }
    }

    async function connectWallet() {
        if (!window.solflare) {
            alert("Solflare Wallet not detected! Please install it.");
            return;
        }

        try {
            await window.solflare.connect();
            wallet = window.solflare;
            console.log("✅ Wallet connected!", wallet.publicKey.toBase58());
            document.getElementById("publicKey").innerText = wallet.publicKey.toBase58();
        } catch (err) {
            console.error("❌ Wallet connection failed:", err);
            alert("Wallet connection failed: " + err.message);
        }
    }

    async function signMessage() {
        if (!wallet) {
            alert("Please connect your wallet first.");
            return;
        }

        try {
            // ✅ First, ensure bs58 is loaded
            await loadBs58();

            // ✅ Prepare the message
            const messageString = "Sign-in to Rugcheck.xyz" + wallet.publicKey.toBase58() + Math.floor(Date.now() / 1000);
            console.log("📜 Message to sign:", messageString);

            // ✅ Sign the message
            const signedMessage = await wallet.signMessage(new TextEncoder().encode(messageString));
            console.log("✅ Signed Message Response:", signedMessage);

            if (!signedMessage || !signedMessage.signature) {
                throw new Error("❌ Solflare did not return a valid signature.");
            }

            // ✅ Convert Uint8Array to Base58 correctly
            const signatureArray = new Uint8Array(signedMessage.signature);
            const base58Signature = bs58.encode(signatureArray);
            console.log("✅ Final Signature (Base58):", base58Signature);

            // ✅ Show signature on the page
            document.getElementById("signature").innerText = base58Signature;

        } catch (err) {
            console.error("❌ Signing failed", err);
            alert("Signing failed: " + err.message);
        }
    }
</script>
