<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Sign Message</title>

    <!-- ‚úÖ Ensure correct loading of required libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bs58/5.0.0/bs58.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js"></script>
</head>

<body>

    <h2>Solana Message Signer</h2>
    <button onclick="connectWallet()">Connect Wallet</button>
    <button onclick="signMessage()">Sign Message</button>

    <p><strong>Public Key:</strong> <span id="publicKey">Not connected</span></p>
    <p><strong>Signature:</strong> <span id="signature">None</span></p>

    <script>
        let wallet;

        function ensureBs58Loaded() {
            return new Promise((resolve, reject) => {
                if (typeof bs58 !== "undefined") {
                    console.log("‚úÖ bs58 is already loaded!");
                    resolve();
                } else {
                    console.log("‚è≥ Loading bs58...");
                    const script = document.createElement("script");
                    script.src = "https://cdnjs.cloudflare.com/ajax/libs/bs58/5.0.0/bs58.min.js";
                    script.onload = () => {
                        if (typeof bs58 !== "undefined") {
                            console.log("‚úÖ bs58 loaded successfully!");
                            resolve();
                        } else {
                            reject("‚ùå Failed to load bs58!");
                        }
                    };
                    script.onerror = () => reject("‚ùå Error loading bs58!");
                    document.head.appendChild(script);
                }
            });
        }

        async function connectWallet() {
            if (!window.solflare) {
                alert("Solflare Wallet not detected! Please install it.");
                return;
            }

            try {
                await window.solflare.connect();
                wallet = window.solflare;
                console.log("‚úÖ Wallet connected!", wallet.publicKey.toBase58());
                document.getElementById("publicKey").innerText = wallet.publicKey.toBase58();
            } catch (err) {
                console.error("‚ùå Wallet connection failed:", err);
                alert("Wallet connection failed: " + err.message);
            }
        }

        async function signMessage() {
            if (!wallet) {
                alert("Please connect your wallet first.");
                return;
            }

            try {
                // ‚úÖ Ensure bs58 is loaded before proceeding
                await ensureBs58Loaded();

                // ‚úÖ Prepare the message
                const messageString = "Sign-in to Rugcheck.xyz " + wallet.publicKey.toBase58() + " " + Math.floor(Date.now() / 1000);
                console.log("üìú Message to sign:", messageString);

                // ‚úÖ Sign the message
                const signedMessage = await wallet.signMessage(new TextEncoder().encode(messageString));
                console.log("‚úÖ Signed Message Response:", signedMessage);

                if (!signedMessage || !signedMessage.signature) {
                    throw new Error("‚ùå Solflare did not return a valid signature.");
                }

                // ‚úÖ Convert Uint8Array to Base58 properly
                const base58Signature = bs58.encode(signedMessage.signature);
                console.log("‚úÖ Final Signature (Base58):", base58Signature);

                // ‚úÖ Display signature on page
                document.getElementById("signature").innerText = base58Signature;

            } catch (err) {
                console.error("‚ùå Signing failed", err);
                alert("Signing failed: " + err.message);
            }
        }
    </script>

</body>
</html>
