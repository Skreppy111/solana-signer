<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solana Sign Message</title>

    <!-- ‚úÖ Load external scripts FIRST -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.7.5/web3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@solana/web3.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bs58"></script> <!-- ‚úÖ MUST be before signMessage() -->
</head>

<body>

    <h2>Solana Message Signer</h2>

    <button onclick="connectWallet()">Connect Wallet</button>
    <button onclick="signMessage()">Sign Message</button>

    <p><strong>Public Key:</strong> <span id="publicKey">Not connected</span></p>
    <p><strong>Signature:</strong> <span id="signature">None</span></p>

    <!-- ‚úÖ Your JavaScript comes AFTER all scripts are loaded -->
    <script>
        let wallet;

        async function connectWallet() {
            if (!window.solflare) {
                alert("Solflare Wallet not detected! Please install it.");
                return;
            }

            try {
                await window.solflare.connect();
                wallet = window.solflare;
                console.log("‚úÖ Wallet connected!", wallet.publicKey.toBase58());
                document.getElementById("publicKey").innerText = wallet.publicKey.toBase58();
            } catch (err) {
                console.error("‚ùå Wallet connection failed:", err);
                alert("Wallet connection failed: " + err.message);
            }
        }

        async function signMessage() {
            if (!wallet) {
                alert("Please connect your wallet first.");
                return;
            }

            try {
                // ‚úÖ Prepare the message
                const messageString = "Sign-in to Rugcheck.xyz" + wallet.publicKey.toBase58() + Math.floor(Date.now() / 1000);
                console.log("üìú Message to sign:", messageString);

                // ‚úÖ Sign the message
                const signedMessage = await wallet.signMessage(new TextEncoder().encode(messageString));
                console.log("‚úÖ Signed Message Response:", signedMessage);

                if (!signedMessage || !signedMessage.signature) {
                    throw new Error("‚ùå Solflare did not return a valid signature.");
                }

                // üî• FIX: Ensure bs58 is loaded before using it
                if (typeof bs58 === "undefined") {
                    console.error("‚ùå Error: bs58 is not defined!");
                    alert("Signing failed: bs58 library is missing!");
                    return;
                }

                // ‚úÖ Convert Uint8Array to Base58 correctly
                const signatureArray = new Uint8Array(signedMessage.signature);
                const base58Signature = bs58.encode(signatureArray);
                console.log("‚úÖ Final Signature (Base58):", base58Signature);

                // ‚úÖ Show signature on the page
                document.getElementById("signature").innerText = base58Signature;

            } catch (err) {
                console.error("‚ùå Signing failed", err);
                alert("Signing failed: " + err.message);
            }
        }
    </script>

</body>
</html>
