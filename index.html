<!-- Load bs58.min.js directly -->
<script src="bs58.min.js"></script>

<script>
    let wallet;

    async function connectWallet() {
        if (!window.solflare) {
            alert("Solflare Wallet not detected! Please install it.");
            return;
        }

        try {
            await window.solflare.connect();
            wallet = window.solflare;
            console.log("âœ… Wallet connected!", wallet.publicKey.toBase58());
            document.getElementById("publicKey").innerText = wallet.publicKey.toBase58();
        } catch (err) {
            console.error("âŒ Wallet connection failed:", err);
            alert("Wallet connection failed: " + err.message);
        }
    }

    async function signMessage() {
        if (!wallet) {
            alert("Please connect your wallet first.");
            return;
        }

        try {
            // âœ… Ensure bs58 is correctly loaded
            if (typeof bs58 === "undefined") {
                throw new Error("âŒ bs58 is not loaded correctly!");
            }

            // âœ… Prepare the message
            const messageString = "Sign-in to Rugcheck.xyz" + wallet.publicKey.toBase58() + Math.floor(Date.now() / 1000);
            console.log("ğŸ“œ Message to sign:", messageString);

            // âœ… Sign the message
            const signedMessage = await wallet.signMessage(new TextEncoder().encode(messageString));
            console.log("âœ… Signed Message Response:", signedMessage);

            if (!signedMessage || !signedMessage.signature) {
                throw new Error("âŒ Solflare did not return a valid signature.");
            }

            // âœ… Convert Uint8Array to Base58
            const base58Signature = bs58.encode(new Uint8Array(signedMessage.signature));
            console.log("âœ… Final Signature (Base58):", base58Signature);

            // âœ… Show signature on the page
            document.getElementById("signature").innerText = base58Signature;

        } catch (err) {
            console.error("âŒ Signing failed:", err);
            alert("Signing failed: " + err.message);
        }
    }
</script>
